<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  
  <title>《Java并发编程的艺术》读书笔记一 | Mark&#39;s Notes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
    <meta name="author" content="Mark">
  
  
    <meta name="description" content="《Java并发编程的艺术》读书笔记">
  
  <meta name="description" content="《Java并发编程的艺术》读书笔记">
<meta property="og:type" content="article">
<meta property="og:title" content="《Java并发编程的艺术》读书笔记一">
<meta property="og:url" content="http://yoursite.com/2015/11/28/《Java并发编程的艺术》读书笔记一/index.html">
<meta property="og:site_name" content="Mark's Notes">
<meta property="og:description" content="《Java并发编程的艺术》读书笔记">
<meta property="og:updated_time" content="2015-11-28T06:37:37.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="《Java并发编程的艺术》读书笔记一">
<meta name="twitter:description" content="《Java并发编程的艺术》读书笔记">
  
  
    <link rel="icon" type="image/x-icon" href="/fancybox/logo.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
</head>

<body>
  <div class="wrapper">
    <header id="header">
  <div class="title">
    <h1><a href="/">Mark&#39;s Notes</a></h1>
    <p><a href="/">I think therefore I am</a></p>
  </div>
  <nav class="nav">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/archives">Archives</a></li>
      
      
    </ul>
    <div class="clearfix"></div>
  </nav>
  <div class="clearfix"></div>
</header>
    <div class="content"><article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2015/11/28/《Java并发编程的艺术》读书笔记一/">
  <time datetime="2015-11-27T16:00:00.000Z">
    2015-11-28
  </time>
</a>
    
    
  
    <h1 class="title">《Java并发编程的艺术》读书笔记一</h1>
  

  </header>
  
  <div class="entry">
    
      <p>《Java并发编程的艺术》读书笔记</p>
<a id="more"></a>
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="http://music.163.com/outchain/player?type=2&id=27556211&auto=0&height=66"></iframe>

<p>为什么要并发？现在的机器都是带多核处理器的，为了能充分发挥多核处理器的优势，并发编程就派上用场了。当然，在单核处理器的情况下，如果碰到了IO密集型的程序，并发编程也能重复利用处理器。并发的多线程程序通常响应更快。</p>
<p>但是，并发程序更快并不是绝对的，线程之间的上下文切换是需要消耗时间的，如果上下文切换花费的时间多于多线程带来的程序执行的减少时间，那么并发程序反而比串行执行程序花费的时间更多。</p>
<p>而且，编写并发程序往往要比编写串行程序难。</p>
<h2 id="Java并发机制的底层实现原理">Java并发机制的底层实现原理</h2><h3 id="volatile">volatile</h3><p><code>volatile</code>关键字能够保证被修饰的变量的<strong>可见性</strong>和<strong>顺序性</strong>。</p>
<p>由于CPU的速度和内存的速度有着巨大的差距，为了提高处理速度，CPU不直接与内存进行交互，而是先将数据读到CPU的高速缓存，然后CPU从高速缓存读取数据，写也先写到高速缓存中，然后再写入内存，每个CPU都有高速缓存，这样就会出现CPU读到的数据可能与内存中的数据不一致。</p>
<p><code>volatile</code>变量的写，在写完高速缓存后会马上写入内存，每次读都会先使高速缓存实现，然后从内存读取。<code>volatile</code>变量也不会与其他变量发生重排序。</p>
<h3 id="synchronized">synchronized</h3><p><code>synchronized</code>关键字可以修饰方法，也可以用在同步代码块中，修饰静态方法时，使用的锁是当前类的Class对象，修饰普通方法时，使用的锁是当前对象，用在同步代码块的时候需要自己指定锁。</p>
<p>Java中的对象在对象头部分会存有HashCode值、分代年龄和锁标记。</p>
<p><code>synchronized</code>使用的锁又4种状态：无锁状态、偏向锁状态、轻量级锁状态和重量级锁状态。</p>
<h4 id="偏向锁">偏向锁</h4><p>研究发现，在多数情况下，锁总是由同一个线程多次获得，为了让线程获得锁的代价更低就引入了偏向锁。</p>
<p>在锁对象的锁标记中会记录偏向的线程的ID，在该线程要获得该锁时，只要测试一下这个锁对象的锁标记是否指向该线程就可以了，如果不是，则测试一下该锁对象是否是偏向锁，是的话就通过CAS设置该锁指向当前线程，如果不是，则通过CAS来竞争锁。</p>
<p>偏向锁使用了一种等到竞争出现才释放锁的机制，所以当其他线程尝试竞争锁时，持有该锁的线程才会释放锁。</p>
<h4 id="轻量级锁">轻量级锁</h4><p>轻量级锁在获取的时候，会先将锁的对象头中的Mark Word数据复制到线程栈的锁记录中，然后通过CAS将锁的对象头中的标记指向该锁记录，如果成功则获得了锁。</p>
<p>释放轻量级锁时，通过CAS将锁记录复制到锁对象的对象头中，如果失败则升级到重量级锁。</p>
<h4 id="重量级锁">重量级锁</h4><p>重量级锁就是一般意义上的锁，会阻塞线程。</p>
<h4 id="锁的对比">锁的对比</h4><table>
<thead>
<tr>
<th>锁</th>
<th>优点</th>
<th>缺点</th>
<th>使用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td>偏向锁</td>
<td>加锁和解锁不需要额外的消耗</td>
<td>如果线程间存在锁竞争，会带来额外的锁撤销消耗</td>
<td>适用于只有一个线程访问同步块的场景</td>
</tr>
<tr>
<td>轻量级锁</td>
<td>竞争的线程不会阻塞，提供了程序的响应时间</td>
<td>如果始终得不到锁，会自旋消耗CPU</td>
<td>最近响应时间，同步代码块执行速度块</td>
</tr>
<tr>
<td>重量级锁</td>
<td>线程竞争不使用自旋，不会消耗CPU</td>
<td>线程阻塞，响应时间缓慢</td>
<td>最近吞吐量，同步代码块执行速度长</td>
</tr>
</tbody>
</table>
<h3 id="原子操作">原子操作</h3><p>原子操作是指不可被中断的一个或多个操作。</p>
<p>CAS（比较并交换），输入两个值，一个旧值和一个新值，如果旧值没有变化，就将其设置为新值，如果变化了就不做处理。</p>
<p>Java中可以通过锁和CAS来实现原子操作。从JDK1.5开始java.util.concurrent.atomic包中包含了一些支持原子操作的类。</p>
<h4 id="CAS实现原子操作的问题">CAS实现原子操作的问题</h4><ul>
<li><p>ABA问题</p>
<p>  旧值从A变成B然后又变回A，这种情况，CAS无法感知，会认为旧值一直没变过。</p>
</li>
<li><p>循环时间长开销大</p>
<p>  自旋CAS如果长时间不成功，会给CPU带来非常的开销。</p>
</li>
<li><p>只能保证一个共享变量的原子操作</p>
<p>  如果要对个共享变量的操作，CAS就无力了。</p>
</li>
</ul>
<h4 id="锁实现原子操作">锁实现原子操作</h4><p>使用锁实现原子操作，只有获得锁的线程才能进入代码块或方法，在锁所保护的代码块或方法内可以又任意多个操作。</p>
<p>除了偏向锁，其他锁的获取都是通过CAS方式来获取的。</p>

    
  </div>
  <footer>
    
      
      
  <div class="tags">
    <a class="tags-link" href="/tags/Java/">Java</a>
  </div>

    
    <div class="clearfix"></div>
  </footer>
</article>


<section id="comment">
  <h1 class="title">评论</h1>
  <div class="ds-thread" data-title="《Java并发编程的艺术》读书笔记一">
  </div>
</section>
</div>
  </div>
  <footer id="footer"><div class="copyright">
  
  &copy; 2015 <a href="/">Mark</a>
  
</div>
<div class="theme-copyright">
  Theme by <a href="https://github.com/orderedlist" target="_blank">orderedlist</a>
   | 
  Redesign by <a href="http://heroicyang.com/" target="_blank">Heroic Yang</a>
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
<script src="/js/scale.fix.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
  var duoshuoQuery = { short_name: 'ztmark' };
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';
    ds.async = true;
    ds.src = 'http://static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
  (function($){
    $('.fancybox').fancybox();
  })(jQuery);
</script>

</body>
</html>